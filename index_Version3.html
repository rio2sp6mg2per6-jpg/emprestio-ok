<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>SISTEMA DE NEGOCIAÇÃO - EDSON</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto+Mono:wght@300;500&display=swap');

        :root {
            --deep-purple: #110524;
            --neon-green: #00ff00;
            --punk-red: #ff3e00;
            --text-white: #f0f0f0;
            --accent-purple: #3d1b5c;
        }

        html,body { height:100%; }
        body {
            background: var(--deep-purple);
            color: var(--text-white);
            font-family: 'Roboto Mono', monospace;
            margin: 0;
            padding-bottom: 50px;
        }

        #progress-bar { position: fixed; top: 0; left: 0; height: 6px; background: linear-gradient(90deg, var(--punk-red), var(--neon-green)); width: 0%; z-index: 1000; transition: 0.4s ease; }

        .container { max-width: 820px; margin: 56px auto; padding: 30px; text-align: center; background: rgba(0,0,0,0.6); border-radius: 20px; border: 1px solid var(--accent-purple); box-shadow: 0 0 40px rgba(0,0,0,0.8); }
        .info-header { position: fixed; top: 20px; right: 20px; background: var(--neon-green); color: #000; padding: 8px 15px; border-radius: 5px; font-family: 'Orbitron', sans-serif; font-weight: bold; font-size: 0.75rem; z-index: 1001; }
        .info-header[aria-live] { min-width:140px; }

        h2,h3 { font-family: 'Orbitron', sans-serif; text-transform: uppercase; color: var(--neon-green); text-shadow: 0 0 10px rgba(0,255,0,0.2); margin: 0 0 12px; }

        .form-section { background: rgba(61,27,92,0.12); padding: 20px; margin: 20px 0; border-radius: 12px; border-left: 4px solid var(--neon-green); text-align: left; }
        .section-title { font-size: 0.8rem; color: #bbb; margin-bottom: 12px; text-transform: uppercase; font-weight: bold; display: block; }

        input, select { border: none; border-bottom: 2px solid rgba(255,255,255,0.08); background: rgba(0,0,0,0.28); font-size: 1.05rem; outline: none; color: #fff; padding: 12px; width: 100%; margin-bottom: 12px; box-sizing: border-box; border-radius: 6px; }
        input:focus, select:focus { border-bottom: 2px solid var(--neon-green); background: rgba(0,0,0,0.44); box-shadow: 0 0 6px rgba(0,255,0,0.06); }

        .btn-confirm { background: var(--neon-green); color: #000; font-weight: 700; padding: 14px; border: none; cursor: pointer; text-transform: uppercase; width: 100%; font-size: 1.05rem; border-radius: 8px; font-family: 'Orbitron', sans-serif; margin-top: 8px; transition: 0.2s; }
        .btn-confirm:hover { background: #e6ffe6; transform: translateY(-1px); }
        .btn-voltar { background: transparent; color: #aaa; border: 1px solid #444; padding: 10px; cursor: pointer; text-transform: uppercase; width: 100%; font-size: 0.9rem; border-radius: 8px; margin-top: 10px; }
        .btn-voltar:hover { color: #fff; border-color: #fff; }
        .btn-pdf { background: var(--punk-red); color: #fff; margin-top: 10px; }

        .loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: var(--deep-purple); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 2000; }
        .spinner { border: 4px solid rgba(255,255,255,0.1); border-left-color: var(--neon-green); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .hidden { display: none; }
        .alerta-grave { background: var(--punk-red); color: #fff; padding: 15px; border-radius: 8px; font-weight: bold; margin: 20px 0; font-size: 0.8rem; border: 1px solid #fff; }

        #documento-pdf { background: white; color: black; padding: 50px; text-align: left; font-family: Arial, sans-serif; display: none; max-width:800px; margin:0 auto; }
        .pdf-header { text-align: center; border-bottom: 2px solid black; padding-bottom: 10px; margin-bottom: 30px; }
        .pdf-row { margin-bottom: 12px; font-size: 14px; border-bottom: 1px solid #eee; padding-bottom: 4px; }

        #caixa-revisao { word-break: break-word; }
        @media (max-width:640px) {
            .container { margin: 20px; padding: 20px; }
        }
    </style>
</head>
<body>

<div id="loading" class="hidden loading-overlay" aria-hidden="true"><div class="spinner" aria-hidden="true"></div><h3 id="loading-msg">PROCESSANDO...</h3></div>
<div id="progress-bar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-label="Progresso do formulário"></div>
<div class="info-header" id="user-display" aria-live="polite">AGUARDANDO...</div>

<div class="container" role="main">
    <div id="step-1" data-step="1">
        <h2>Identificação</h2>
        <label for="input-nome" class="hidden">Nome completo</label>
        <input type="text" id="input-nome" placeholder="DIGITE SEU NOME COMPLETO" aria-label="Nome completo" />
        <button type="button" class="btn-confirm" id="btn-acessar">ACESSAR SISTEMA</button>
    </div>

    <div id="step-2" class="hidden" data-step="2">
        <h3 id="welcome-msg">BEM‑VINDO</h3>
        <button type="button" class="btn-confirm" id="btn-solicitar">SOLICITAR DINHEIRO</button>
        <button type="button" class="btn-confirm" id="btn-renegociar" style="background:#fff;color:#000">RENEGOCIAR</button>
        <button type="button" class="btn-voltar" id="btn-voltar-inicio">← VOLTAR AO INÍCIO</button>
    </div>

    <div id="step-pergunta-cliente" class="hidden" data-step="3">
        <h2>Verificação de Perfil</h2>
        <p>VOCÊ JÁ É CLIENTE?</p>
        <button type="button" class="btn-confirm" id="btn-sou-cliente">SIM, SOU CLIENTE</button>
        <button type="button" class="btn-confirm" id="btn-nao-cliente" style="background:#fff;color:#000">NÃO, FAZER CADASTRO</button>
        <button type="button" class="btn-voltar" id="btn-voltar-step2">← VOLTAR</button>
    </div>

    <div id="step-dinheiro" class="hidden" data-step="4">
        <h2 id="label-valor">QUAL É O VALOR?</h2>
        <label for="valor-solicitado" class="hidden">Valor solicitado</label>
        <input type="number" id="valor-solicitado" placeholder="VALOR (R$)" aria-label="Valor solicitado em reais" min="1" step="0.01" />
        <button type="button" class="btn-confirm" id="btn-analise">ANALISAR CRÉDITO</button>
        <button type="button" class="btn-voltar" id="btn-voltar-pergunta">← VOLTAR</button>
    </div>

    <div id="step-pagamento" class="hidden" data-step="5">
        <h2>Forma de Pagamento</h2>
        <p style="color:#ddd; font-size:0.9rem;">Observação: as taxas indicadas são por parcela e se acumulam conforme o número de parcelas (ex.: 2 parcelas → 80% PIX ou 60% CRYPTON).</p>
        <label for="metodo" class="hidden">Selecione método</label>
        <select id="metodo" aria-label="Método de pagamento">
            <option value="0.4">PIX (TAXA POR PARCELA: 40%)</option>
            <option value="0.3">CRYPTON (TAXA POR PARCELA: 30%)</option>
        </select>
        <p>PARCELAS (MÁX. 6):</p>
        <label for="parcelas" class="hidden">Número de parcelas</label>
        <input type="number" id="parcelas" min="1" max="6" value="1" aria-label="Número de parcelas" />
        <button type="button" class="btn-confirm" id="btn-calcular">CALCULAR ACORDO</button>
        <button type="button" class="btn-voltar" id="btn-voltar-dinheiro">← VOLTAR</button>
    </div>

    <div id="step-dados" class="hidden" data-step="6">
        <h2>Dados para o Contrato</h2>
        <div class="form-section">
            <span class="section-title">Pessoal</span>
            <input type="text" id="f-cpf" placeholder="CPF: 000.000.000-00" maxlength="14" aria-label="CPF" />
            <input type="text" id="f-nasc" placeholder="DATA DE NASCIMENTO: 00/00/0000" maxlength="10" aria-label="Data de nascimento" />
        </div>
        <div class="form-section">
            <span class="section-title">Endereço</span>
            <input type="text" id="f-rua" placeholder="RUA E NÚMERO" aria-label="Rua e número" />
            <input type="text" id="f-cidade" placeholder="CIDADE / UF" aria-label="Cidade e estado" />
            <input type="text" id="f-cep" placeholder="CEP: 00000-000" maxlength="9" aria-label="CEP" />
        </div>
        <button type="button" class="btn-confirm" id="btn-revisar">GERAR REVISÃO</button>
        <button type="button" class="btn-voltar" id="btn-voltar-pagamento">← VOLTAR AO CÁLCULO</button>
    </div>

    <div id="step-final" class="hidden" data-step="7">
        <h2>Conferência Final</h2>
        <div id="caixa-revisao" style="text-align:left; background:#000; padding:20px; border:1px solid var(--neon-green); border-radius:10px;"></div>
        <div class="alerta-grave" role="alert">ATENÇÃO: MULTA DE R$ 50,00 POR ATRASO E PERDA DO BEM CORRESPONDENTE.</div>
        <button type="button" class="btn-confirm" id="btn-whatsapp">CONFIRMAR E ENVIAR WHATSAPP</button>
        <button type="button" class="btn-confirm btn-pdf" id="btn-pdf">SALVAR CONTRATO EM PDF</button>
        <button type="button" class="btn-voltar" id="btn-voltar-dados">← CORRIGIR DADOS</button>
    </div>

    <div id="erro-cred" class="hidden" data-step="8">
        <h2 style="color:var(--punk-red)">ACESSO NEGADO</h2>
        <p id="msg-erro-txt"></p>
        <button type="button" class="btn-confirm" id="btn-reiniciar">VOLTAR AO INÍCIO</button>
    </div>
</div>

<div id="documento-pdf" aria-hidden="true">
    <div class="pdf-header"><h1>TERMO DE ACORDO - EDSON</h1></div>
    <div id="pdf-conteudo"></div>
    <div style="margin-top:40px; border-top:1px solid #000; text-align:center;">
        <p>Assinatura do Solicitante</p>
        <p id="pdf-nome-ass" style="font-weight:bold; font-style:italic;"></p>
    </div>
</div>

<script>
    // Constantes
    const WHATSAPP_NUM = "5511963208609";

    // Estado do usuário
    let user = { nome: "", valor: 0, total: 0, parcelas: 0, listaP: [], isCliente: false, metodo: '' };

    // Helper rápido
    const $ = id => document.getElementById(id);
    const steps = ['step-1','step-2','step-pergunta-cliente','step-dinheiro','step-pagamento','step-dados','step-final','erro-cred'];

    // Formatação de moeda
    const fmt = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });

    // Util sanitizar filename
    function sanitizeFilename(name) {
        return name ? name.normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/\s+/g, '_').replace(/[^\w\-_.]/g, '') : 'ACORDO';
    }

    // Loader
    function loader(msg, cb) {
        $('loading').classList.remove('hidden');
        $('loading').setAttribute('aria-hidden','false');
        $('loading-msg').innerText = msg;
        setTimeout(() => { $('loading').classList.add('hidden'); $('loading').setAttribute('aria-hidden','true'); cb(); }, 900);
    }

    // Atualiza exibição de passos e barra de progresso
    function showStep(showId) {
        steps.forEach(id => {
            const el = $(id);
            if(!el) return;
            if(id === showId) el.classList.remove('hidden'); else el.classList.add('hidden');
        });
        // atualizar progress
        const idx = Math.max(0, steps.indexOf(showId));
        const pct = Math.round(((idx + 1) / steps.length) * 100);
        $('progress-bar').style.width = pct + '%';
        $('progress-bar').setAttribute('aria-valuenow', pct);
    }

    // Máscaras
    function applyMasks() {
        const mask = (el, fn) => {
            if(!el) return;
            el.addEventListener('input', e => e.target.value = fn(e.target.value));
        };
        mask($('f-cpf'), v => v.replace(/\D/g,"").replace(/(\d{3})(\d)/,"$1.$2").replace(/(\d{3})(\d)/,"$1.$2").replace(/(\d{3})(\d{1,2})$/,"$1-$2"));
        mask($('f-nasc'), v => v.replace(/\D/g,"").replace(/(\d{2})(\d)/,"$1/$2").replace(/(\d{2})(\d)/,"$1/$2"));
        mask($('f-cep'), v => v.replace(/\D/g,"").replace(/(\d{5})(\d)/,"$1-$2"));
    }

    // Inicialização e bindings
    function init() {
        applyMasks();
        showStep('step-1');

        // Botões
        $('btn-acessar').addEventListener('click', setInitialName);
        $('btn-solicitar').addEventListener('click', () => selectOption('DINHEIRO'));
        $('btn-renegociar').addEventListener('click', () => selectOption('RENEGOCIAR'));
        $('btn-voltar-inicio').addEventListener('click', () => showStep('step-1'));

        $('btn-sou-cliente').addEventListener('click', () => setStatusCliente(true));
        $('btn-nao-cliente').addEventListener('click', () => setStatusCliente(false));
        $('btn-voltar-step2').addEventListener('click', () => showStep('step-2'));

        $('btn-analise').addEventListener('click', checkValor);
        $('btn-voltar-pergunta').addEventListener('click', () => showStep('step-pergunta-cliente'));

        $('btn-calcular').addEventListener('click', gerarAcordoFinal);
        $('btn-voltar-dinheiro').addEventListener('click', () => showStep('step-dinheiro'));

        $('btn-revisar').addEventListener('click', revisarDados);
        $('btn-voltar-pagamento').addEventListener('click', () => showStep('step-pagamento'));

        $('btn-whatsapp').addEventListener('click', enviarWhatsAppFinal);
        $('btn-pdf').addEventListener('click', baixarPDF);
        $('btn-voltar-dados').addEventListener('click', () => showStep('step-dados'));

        $('btn-reiniciar').addEventListener('click', () => location.reload());
    }

    // Navegação simplificada
    function voltar(atual, anterior) { showStep(anterior); }

    // Set initial name
    function setInitialName() {
        const raw = $('input-nome').value.trim();
        user.nome = raw.toUpperCase();
        if(!raw || user.nome.split(' ').length < 2 || user.nome.length < 5) {
            return alert("NOME COMPLETO OBRIGATÓRIO.");
        }
        loader("VALIDANDO ACESSO...", () => {
            showStep('step-2');
            $('user-display').innerText = "OPERADOR: " + user.nome.split(' ')[0];
            $('welcome-msg').innerText = `BEM‑VINDO, ${user.nome.split(' ')[0]}!`;
        });
    }

    // Selecionar opção
    function selectOption(o) {
        if(o === 'DINHEIRO') {
            showStep('step-pergunta-cliente');
        } else {
            // Renegociar -> abrir WhatsApp com mensagem codificada
            const msg = `Olá Edson, sou ${user.nome || '[NOME]'} e quero renegociar.`;
            const url = `https://wa.me/${WHATSAPP_NUM}?text=${encodeURIComponent(msg)}`;
            window.open(url, '_blank', 'noopener');
        }
    }

    function setStatusCliente(s) {
        user.isCliente = !!s;
        if(!s) {
            $('label-valor').innerText = "VALOR (MÁX. R$ 500 PARA NOVOS):";
        } else {
            $('label-valor').innerText = "QUAL É O VALOR?";
        }
        showStep('step-dinheiro');
    }

    // Validação e análise do valor
    function checkValor() {
        const raw = parseFloat($('valor-solicitado').value);
        user.valor = isFinite(raw) ? raw : NaN;

        if(isNaN(user.valor) || user.valor <= 0) {
            return alert('Informe um valor válido maior que zero.');
        }

        if(!user.isCliente && user.valor > 500) {
            $('msg-erro-txt').innerText = "LIMITE NEGADO PARA NOVOS PERFIS.";
            showStep('erro-cred');
            return;
        }

        loader("ANALISANDO RISCO...", () => showStep('step-pagamento'));
    }

    // Gerar acordo - regra: juros acumulado por parcelas (taxa por parcela * parcelas)
    function gerarAcordoFinal() {
        const tx = parseFloat($('metodo').value); // taxa por parcela (ex: 0.4 ou 0.3)
        let parcelas = parseInt($('parcelas').value, 10);
        if(!isFinite(parcelas) || parcelas < 1) parcelas = 1;
        parcelas = Math.min(6, parcelas);

        if(isNaN(user.valor) || user.valor <= 0) {
            return alert('Valor inválido. Volte e informe um valor correto.');
        }

        user.parcelas = parcelas;
        user.metodo = tx === 0.4 ? 'PIX' : 'CRYPTON';

        // Regra solicitada: juros acumulado por parcelas
        // total = valor * (1 + taxa_por_parcela * parcelas)
        const accumulatedRate = tx * user.parcelas;
        user.total = +(user.valor * (1 + accumulatedRate));
        const vU = user.total / user.parcelas;

        user.listaP = [];
        for(let i=1;i<=user.parcelas;i++) {
            const d = new Date();
            d.setMonth(d.getMonth() + i);
            user.listaP.push({ n: i, data: d.toLocaleDateString('pt-BR'), v: +vU.toFixed(2) });
        }

        user.accumulatedRate = accumulatedRate; // salvar para revisão
        showStep('step-dados');
    }

    // Revisão de dados antes de finalizar
    function revisarDados() {
        if(!$('f-cpf').value || !$('f-rua').value) {
            return alert("PREENCHA O CPF E O ENDEREÇO (RUA).");
        }

        let pHTML = "";
        user.listaP.forEach(p => pHTML += `<div style="color:var(--neon-green)">${p.n}ª Parc: ${p.data} - ${fmt.format(p.v)}</div>`);

        const percentAccum = (user.accumulatedRate * 100).toFixed(2) + '%';
        const perParcel = ((user.accumulatedRate / user.parcelas) * 100).toFixed(2) + '%';

        $('caixa-revisao').innerHTML = `<strong>Nome:</strong> ${user.nome}<br><strong>CPF:</strong> ${$('f-cpf').value}<br><strong>MÉTODO:</strong> ${user.metodo} (taxa por parcela ${(user.metodo==='PIX')? '40%' : '30%'} )<br><strong>Juros acumulado:</strong> ${percentAccum} (${perParcel} por parcela em média)<br><strong>PLANO:</strong><br>${pHTML}<br><strong>TOTAL: ${fmt.format(user.total)}</strong>`;
        showStep('step-final');
    }

    // Gerar e baixar PDF
    function baixarPDF() {
        const doc = $('documento-pdf');
        doc.style.display = 'block';
        doc.setAttribute('aria-hidden','false');

        let pPDF = "";
        user.listaP.forEach(p => pPDF += `<div class="pdf-row">${p.n}ª Parcela: ${p.data} - ${fmt.format(p.v)}</div>`);

        const percentAccum = (user.accumulatedRate * 100).toFixed(2) + '%';

        $('pdf-conteudo').innerHTML = `<div class="pdf-row"><strong>NOME:</strong> ${user.nome}</div><div class="pdf-row"><strong>MÉTODO:</strong> ${user.metodo}</div><div class="pdf-row"><strong>JUROS ACUMULADO:</strong> ${percentAccum}</div><div class="pdf-row"><strong>TOTAL:</strong> ${fmt.format(user.total)}</div><h3 style="margin-top:20px">CRONOGRAMA:</h3>${pPDF}`;
        $('pdf-nome-ass').innerText = user.nome;

        const filename = `ACORDO_${sanitizeFilename(user.nome)}.pdf`;
        html2pdf().from(doc).set({ margin: 15, filename }).save().then(() => {
            doc.style.display = 'none';
            doc.setAttribute('aria-hidden','true');
        }).catch(err => {
            doc.style.display = 'none';
            doc.setAttribute('aria-hidden','true');
            alert('Erro ao gerar PDF: ' + (err && err.message ? err.message : err));
        });
    }

    // Enviar mensagem final por WhatsApp (codificada)
    function enviarWhatsAppFinal() {
        if(!$('f-cpf').value) return alert('Por favor, informe o CPF antes de enviar.');

        let msg = `*PROTOCOLO EDSON*\n\nCLIENTE: ${user.nome}\nCPF: ${$('f-cpf').value}\nMÉTODO: ${user.metodo}\nPARCELAS: ${user.parcelas}\nJUROS ACUMULADO: ${(user.accumulatedRate*100).toFixed(2)}%\n\n`;
        user.listaP.forEach(p => msg += `${p.n}ª Parc: ${p.data} - ${fmt.format(p.v)}\n`);
        msg += `\n*TOTAL:* ${fmt.format(user.total)}\n\nCiente de multa e perda do bem.`;

        const url = `https://wa.me/${WHATSAPP_NUM}?text=${encodeURIComponent(msg)}`;
        window.open(url, '_blank', 'noopener');
    }

    // Inicializa após carregamento
    document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>